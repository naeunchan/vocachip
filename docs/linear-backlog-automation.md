# Linear Backlog Automation (GitHub Actions)

This repository includes:

- Workflow: `.github/workflows/linear-backlog-automation.yml`
- Runner script: `scripts/automation/linear_backlog_e2e.sh`

The workflow is manual (`workflow_dispatch`) and processes Linear backlog issues one-by-one.

## Required secrets

- `LINEAR_API_KEY`: Linear personal/workspace API key
- `OPENAI_API_KEY`: Required when `ai_generate_issue_script=true`

## Optional repo variables

- `LINEAR_TEAM_ID`
- `LINEAR_PROJECT_ID`
- `LINEAR_ASSIGNEE_ID`
- `LINEAR_STATE_TODO`
- `LINEAR_STATE_INPROGRESS`
- `LINEAR_STATE_DONE`
- `DEFAULT_BRANCH` (`main` by default)

If workflow state IDs are not provided, the script tries to resolve them automatically.

## How to run

1. Open **Actions** -> **Linear Backlog Automation** -> **Run workflow**
2. Set inputs:
    - `max_issues`: number of issues to process
    - `dry_run`: `true` (default). Set `false` for real write operations
    - `implement_command`: command that performs implementation for each issue
    - `issue_script_path`: optional explicit script path
    - `implement_fallback_command`: fallback command when no issue script exists
    - `auto_generate_issue_script`: auto-create `scripts/automation/issues/<ISSUE_IDENTIFIER>.sh` when missing
    - `ai_generate_issue_script`: generate missing issue script via OpenAI API
    - `openai_model`: model name for AI script generation (default: `gpt-5`)
    - `verify_commands`: lint/test/build commands
    - `auto_merge`: `true` (default) for fully automated merge, `false` for manual merge flow

Default `implement_command` is `scripts/automation/issue_worker.sh`.
It dispatches to `scripts/automation/issues/<ISSUE_IDENTIFIER>.sh`.

## Important behavior

- The script enforces clean working tree checks before each issue.
- Backlog selection is `not Done/canceled`, ordered by `priority` then `createdAt`, with optional label filtering.
- Issues already labeled `automation-in-progress` are skipped.
- If `LINEAR_ASSIGNEE_ID` is unset, assigned issues are skipped unless assigned to the current Linear viewer.
- Branch format is `linear/<IDENTIFIER>-<kebab-title>`.
- It runs implementation, verification commands, an additional diff/secret second-check, then opens a PR.
- CI is watched (`gh pr checks --watch`), with retry support via `auto_fix_command`.
- Merge conflicts trigger automatic rebase retry; if unresolved, automation stops with Linear diagnostics.
- Strict one-by-one mode: next issue is not processed until PR merge + default branch sync + Linear Done update.
- If `auto_merge=false`, the run stops after PR creation and exits successfully (manual merge required).
- If `auto_merge=false` and `max_issues > 1`, `max_issues` is forced to `1`.
- If `implement_command` is missing, automation stops with a Linear comment.
- `issue_worker.sh` can auto-generate issue scripts if `auto_generate_issue_script=true`.
- Generated scripts call `IMPLEMENT_FALLBACK_COMMAND` when configured.
- With `ai_generate_issue_script=true` and `OPENAI_API_KEY`, missing scripts are generated by OpenAI.

## Stopping conditions

- Missing `LINEAR_API_KEY` and no Linear CLI available.
- `gh` not authenticated.
- Push/PR/merge permissions failure.
- Repeated CI failures beyond `max_fix_attempts`.

## Example input commands

```bash
implement_command: scripts/automation/issue_worker.sh
auto_generate_issue_script: true
ai_generate_issue_script: true
openai_model: gpt-5
implement_fallback_command: ./scripts/automation/your_generic_issue_impl.sh
verify_commands: npm run lint -- --max-warnings=0 && npm test -- --watch=false
```
