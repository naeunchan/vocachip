name: CI

on:
    push:
    pull_request:

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: npm
            - name: Install dependencies
              run: npm ci
            - name: Lint
              run: npm run lint -- --max-warnings=0
            - name: Test
              run: npm test -- --watch=false
            # - name: Expo doctor
            #   run: npx expo-doctor
            - name: Build (web export)
              run: npm run ci:build

    android-e2e-recovery:
        runs-on: ubuntu-latest
        timeout-minutes: 60
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: npm
            - name: Install dependencies
              run: npm ci
            - name: Generate Android native project
              run: npx expo prebuild --platform android --no-install
            - uses: actions/setup-java@v4
              with:
                  distribution: temurin
                  java-version: "17"
                  cache: gradle
            - name: Install Maestro CLI
              run: |
                  curl -Ls "https://get.maestro.mobile.dev" | bash
                  echo "$HOME/.maestro/bin" >> "$GITHUB_PATH"
            - name: Run Android runtime E2E (Recovery)
              uses: reactivecircus/android-emulator-runner@v2
              with:
                  api-level: 34
                  arch: x86_64
                  target: google_apis
                  profile: pixel_6
                  disable-animations: true
                  emulator-options: -no-window -gpu swiftshader_indirect -no-snapshot -noaudio -no-boot-anim
                  script: |
                      set -euo pipefail
                      mkdir -p .maestro/results
                      trap 'adb logcat -d > .maestro/results/logcat.txt || true' EXIT
                      pushd android
                      ./gradlew :app:assembleRelease -PreactNativeArchitectures=x86_64
                      popd
                      adb install -r android/app/build/outputs/apk/release/app-release.apk
                      npm run test:e2e:recovery:android
            - name: Upload Android E2E artifacts
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: android-recovery-e2e-artifacts
                  path: .maestro/results
                  if-no-files-found: warn
